name: Build DebGPT Packages

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-24.04
    container:
      image: debian:trixie

    steps:
      - name: Install base tooling
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y --no-install-recommends \
            bash \
            build-essential \
            ca-certificates \
            curl \
            debhelper \
            dpkg-dev \
            fakeroot \
            devscripts \
            equivs \
            git \
            lintian \
            procps \
            python3 \
            python3-pip \
            python3-setuptools \
            python3-venv \
            python3-wheel

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install package build-dependencies
        run: |
          if [ -d debgpt7.8-src/debian ]; then
            BUILD_DIR="debgpt7.8-src"
          else
            BUILD_DIR="."
          fi
          echo "Installing build dependencies from ${BUILD_DIR}/debian/control"
          (cd "$BUILD_DIR" && mk-build-deps -i -r -t "apt-get -o Debug::pkgProblemResolver=yes --no-install-recommends -y" debian/control)
          (cd "$BUILD_DIR" && rm -f ./*-build-deps_*.deb)

      - name: Build Debian packages
        run: |
          echo "::group::Workspace contents"
          ls -al
          echo "::endgroup::"
          ROOT_DIR=$(pwd)
          if [ -d debgpt7.8-src/debian ]; then
            BUILD_DIR="debgpt7.8-src"
          else
            BUILD_DIR="."
          fi
          echo "Building from ${BUILD_DIR}"
          (cd "$BUILD_DIR" && dpkg-buildpackage -us -uc)
          ARTIFACT_SOURCE=$(cd "$BUILD_DIR" && cd .. && pwd)
          if [ "${ARTIFACT_SOURCE}" != "${ROOT_DIR}" ]; then
            shopt -s nullglob
            for ext in changes deb dsc; do
              for file in "${ARTIFACT_SOURCE}"/*.${ext}; do
                [ -e "${file}" ] || continue
                mv "${file}" "${ROOT_DIR}/"
              done
            done
            for file in "${ARTIFACT_SOURCE}"/*.tar.*; do
              [ -e "${file}" ] || continue
              mv "${file}" "${ROOT_DIR}/"
            done
            shopt -u nullglob
          fi

      - name: Install generated packages
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          DEB_LIST=$(find . -maxdepth 1 -type f \( -name "debgpt_*.deb" -o -name "debgpt-vector-service_*.deb" \) | sort)
          if [ -z "${DEB_LIST}" ]; then
            echo "No Debian packages found in workspace" >&2
            exit 1
          fi
          # shellcheck disable=SC2086
          apt-get install -y ${DEB_LIST}

      - name: Run vector DB bootstrapper
        env:
          SKIP_SYSTEMCTL: "1"
        run: |
          set -euo pipefail
          /usr/share/debgpt/vector_service/setup_vectordb.sh

      - name: Validate vector-service environment configuration
        run: |
          set -euo pipefail
          grep -qx 'QDRANT_URL=http://127.0.0.1:6333' /etc/debgpt/vector-service.env
          grep -qx 'QDRANT_COLLECTION=chat_messages' /etc/debgpt/vector-service.env

      - name: Check Qdrant health endpoint
        run: |
          set -euo pipefail
          for attempt in $(seq 1 10); do
            if curl -fsS http://127.0.0.1:6333/healthz >/tmp/qdrant-health.json; then
              cat /tmp/qdrant-health.json
              exit 0
            fi
            sleep 1
          done
          echo "Qdrant health endpoint did not respond in time" >&2
          exit 1

      - name: Run lintian
        if: always()
        run: |
          if ls *.changes 1>/dev/null 2>&1; then
            lintian *.changes || true
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debgpt-packages
          path: |
            *.deb
            *.changes
            *.dsc
            *.tar.*
          if-no-files-found: ignore
