name: Build DebGPT Packages

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-24.04
    container:
      image: debian:trixie

    steps:
      - name: Cache APT archives
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('**/debian/control') }}
          restore-keys: ${{ runner.os }}-apt-

      - name: Install base tooling
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y --no-install-recommends \
            bash build-essential ca-certificates curl debhelper dpkg-dev fakeroot \
            devscripts equivs git lintian procps python3 python3-pip python3-setuptools \
            python3-venv python3-wheel jq

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install package build-dependencies
        run: |
          BUILD_DIR="."
          [ -d debgpt7.8-src/debian ] && BUILD_DIR="debgpt7.8-src"
          echo "Installing build dependencies from ${BUILD_DIR}/debian/control"
          (cd "$BUILD_DIR" && mk-build-deps -i -r -t "apt-get --no-install-recommends -y" debian/control)
          (cd "$BUILD_DIR" && rm -f ./*-build-deps_*.deb)

      - name: Build Debian packages
        run: |
          ROOT_DIR=$(pwd)
          BUILD_DIR="."
          [ -d debgpt7.8-src/debian ] && BUILD_DIR="debgpt7.8-src"
          echo "Building from ${BUILD_DIR}"
          (cd "$BUILD_DIR" && fakeroot dpkg-buildpackage -us -uc)
          ARTIFACT_SRC=$(cd "$BUILD_DIR" && cd .. && pwd)
          [ "${ARTIFACT_SRC}" != "${ROOT_DIR}" ] && find "${ARTIFACT_SRC}" -maxdepth 1 -type f \
            \( -name '*.deb' -o -name '*.changes' -o -name '*.dsc' -o -name '*.tar.*' \) \
            -exec mv {} "${ROOT_DIR}/" \;

      - name: Prepare environment
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y adduser curl jq procps

      - name: List generated Debian packages
        run: |
          set -euo pipefail
          find . -maxdepth 1 -type f -name '*.deb' -ls

      - name: Install generated packages (ordered)
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          apt-get update

          DEB_CORE=$(find . -maxdepth 1 -type f -name "debgpt_*.deb" | sort)
          DEB_VECTOR=$(find . -maxdepth 1 -type f -name "debgpt-vector-service_*.deb" | sort)

          if [ -z "${DEB_CORE}${DEB_VECTOR}" ]; then
            echo "No Debian packages found in workspace" >&2
            exit 1
          fi
          if [ -z "${DEB_CORE}" ]; then
            echo "ERROR: debgpt package not found; cannot continue." >&2
            exit 1
          fi

          mkdir -p /usr/lib/systemd/system
          echo "Installing core package(s)..."
          for pkg in ${DEB_CORE}; do
            dpkg -i "${pkg}" || true
          done

          if [ -n "${DEB_VECTOR}" ]; then
            echo "Installing vector-service package(s)..."
            for pkg in ${DEB_VECTOR}; do
              dpkg -i "${pkg}" || true
            done
          else
            echo "Warning: debgpt-vector-service package not found; continuing with core package only" >&2
          fi

          apt-get install -fy
          echo "Package status summary:"
          dpkg -l | grep -E 'debgpt|qdrant' || true
          dpkg --audit || true

      - name: Run vector DB bootstrapper
        id: bootstrap_vectordb
        env:
          SKIP_SYSTEMCTL: "1"
        run: |
          set -euo pipefail
          if ! dpkg-query -W -f='${Status}' debgpt 2>/dev/null | grep -q "install ok installed"; then
            echo "debgpt package not installed/configured; aborting vector DB bootstrap." >&2
            dpkg --audit || true
            exit 2
          fi
          /usr/share/debgpt/vector_service/setup_vectordb.sh

      - name: Bootstrap failure diagnostics
        if: failure() && steps.bootstrap_vectordb.outcome == 'failure'
        run: |
          set -euo pipefail
          for f in /var/log/qdrant/standalone.log /var/log/debgpt/vector-service.log /tmp/debgpt-qdrant-status; do
            [ -f "$f" ] && { echo "--- $f ---"; tail -n 20 "$f"; }
          done

      - name: Ensure Qdrant is running
        run: |
          set -euo pipefail
          if [ -f /tmp/debgpt-qdrant-status ] && grep -qx 'missing' /tmp/debgpt-qdrant-status; then
            echo "Qdrant package not installed; skipping startup attempts." >&2
            exit 0
          fi
          if ! dpkg-query -W -f='${Status}' qdrant 2>/dev/null | grep -q "install ok installed"; then
            if ! command -v qdrant >/dev/null 2>&1; then
              echo "Qdrant not installed; skipping startup attempts." >&2
              exit 0
            fi
          fi
          if command -v systemctl >/dev/null 2>&1; then
            systemctl start qdrant || true
          fi
          if ! pgrep -f '^qdrant' >/dev/null 2>&1; then
            echo "Starting qdrant manually"
            nohup qdrant --config /etc/qdrant/config.yaml >/var/log/qdrant/standalone.log 2>&1 &
          fi

          echo "Waiting for Qdrant to become healthy..."
          timeout=60
          interval=5
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if curl -fsS http://127.0.0.1:6333/healthz -o /tmp/qdrant-health.json 2>/dev/null; then
              echo "Qdrant is healthy:"
              cat /tmp/qdrant-health.json
              exit 0
            fi
            sleep $interval
            elapsed=$((elapsed + interval))
          done
          echo "Qdrant health endpoint did not respond within ${timeout}s" >&2
          exit 1

      - name: Validate vector-service environment configuration
        run: |
          set -euo pipefail
          grep -qx 'QDRANT_URL=http://127.0.0.1:6333' /etc/debgpt/vector-service.env
          grep -qx 'QDRANT_COLLECTION=chat_messages' /etc/debgpt/vector-service.env

      - name: Check DebGPT vector service health endpoint
        run: |
          set -euo pipefail
          curl -fsS --retry 5 --retry-delay 2 --retry-all-errors http://127.0.0.1:8000/healthz | tee /tmp/vector-service-health.json

      - name: Verify installed DebGPT packages
        run: |
          set -euo pipefail
          dpkg -l | grep debgpt

      - name: Run lintian
        if: always()
        run: |
          if ls *.changes 1>/dev/null 2>&1; then
            lintian *.changes || true
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debgpt-packages
          path: |
            *.deb
            *.changes
            *.dsc
            *.tar.*
          if-no-files-found: ignore
