name: Build DebGPT Packages

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        os: [debian:trixie]
    container:
      image: ${{ matrix.os }}

    steps:
      - name: Cache APT archives
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('**/debian/control') }}
          restore-keys: ${{ runner.os }}-apt-

      - name: Install base tooling
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y --no-install-recommends \
            bash \
            build-essential \
            ca-certificates \
            curl \
            debhelper \
            dpkg-dev \
            fakeroot \
            devscripts \
            equivs \
            git \
            lintian \
            procps \
            python3 \
            python3-pip \
            python3-setuptools \
            python3-venv \
            python3-wheel

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install package build-dependencies
        run: |
          if [ -d debgpt7.8-src/debian ]; then
            BUILD_DIR="debgpt7.8-src"
          else
            BUILD_DIR="."
          fi
          echo "Installing build dependencies from ${BUILD_DIR}/debian/control"
          (cd "$BUILD_DIR" && mk-build-deps -i -r -t "apt-get -o Debug::pkgProblemResolver=yes --no-install-recommends -y" debian/control)
          (cd "$BUILD_DIR" && rm -f ./*-build-deps_*.deb)

      - name: Build Debian packages
        run: |
          echo "::group::Workspace contents"
          ls -al
          echo "::endgroup::"
          ROOT_DIR=$(pwd)
          if [ -d debgpt7.8-src/debian ]; then
            BUILD_DIR="debgpt7.8-src"
          else
            BUILD_DIR="."
          fi
          echo "Building from ${BUILD_DIR}"
          (cd "$BUILD_DIR" && dpkg-buildpackage -us -uc)
          ARTIFACT_SOURCE=$(cd "$BUILD_DIR" && cd .. && pwd)
          if [ "${ARTIFACT_SOURCE}" != "${ROOT_DIR}" ]; then
            find "${ARTIFACT_SOURCE}" -maxdepth 1 -type f \
              \( -name '*.changes' -o -name '*.deb' -o -name '*.dsc' \) \
              -exec mv {} "${ROOT_DIR}/" \;
            find "${ARTIFACT_SOURCE}" -maxdepth 1 -type f -name '*.tar.*' \
              -exec mv {} "${ROOT_DIR}/" \;
          fi

      - name: Prepare environment
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y adduser curl jq procps

      - name: List generated Debian packages
        run: |
          set -euo pipefail
          find . -maxdepth 1 -type f -name '*.deb' -ls

      - name: Install generated packages
        run: |
          set -euo pipefail
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          DEB_LIST=$(find . -maxdepth 1 -type f \( -name "debgpt_*.deb" -o -name "debgpt-vector-service_*.deb" \) -print | sort)
          if [ -z "${DEB_LIST}" ]; then
            echo "No Debian packages found in workspace" >&2
            exit 1
          fi
          mkdir -p /usr/lib/systemd/system
          for pkg in ${DEB_LIST}; do
            echo "Installing ${pkg} with dpkg -i"
            dpkg -i "${pkg}" || true
          done
          apt-get install -fy

      # - name: Verify package signatures
      #   run: |
      #     echo "TODO: implement GPG verification for downloaded .deb files"

      - name: Run vector DB bootstrapper
        id: bootstrap_vectordb
        env:
          SKIP_SYSTEMCTL: "1"
        run: |
          set -euo pipefail
          /usr/share/debgpt/vector_service/setup_vectordb.sh

      - name: Bootstrap failure diagnostics
        if: failure() && steps.bootstrap_vectordb.outcome == 'failure'
        run: |
          set -euo pipefail
          if [ -f /var/log/qdrant/standalone.log ]; then
            echo '--- tail /var/log/qdrant/standalone.log ---'
            tail -n 20 /var/log/qdrant/standalone.log
          fi
          if [ -f /var/log/debgpt/vector-service.log ]; then
            echo '--- tail /var/log/debgpt/vector-service.log ---'
            tail -n 20 /var/log/debgpt/vector-service.log
          fi
          if [ -f /tmp/debgpt-qdrant-status ]; then
            echo '--- /tmp/debgpt-qdrant-status ---'
            cat /tmp/debgpt-qdrant-status
          fi

      - name: Ensure Qdrant is running
        run: |
          set -euo pipefail
          if command -v systemctl >/dev/null 2>&1; then
            systemctl start qdrant || true
          fi
          if ! pgrep -f '^qdrant' >/dev/null 2>&1; then
            if command -v qdrant >/dev/null 2>&1; then
              echo "Starting qdrant manually via nohup"
              nohup qdrant --config /etc/qdrant/config.yaml >/var/log/qdrant/standalone.log 2>&1 &
            else
              echo "Qdrant binary not found; skipping manual start"
            fi
          fi
          sleep 5

      - name: Validate vector-service environment configuration
        run: |
          set -euo pipefail
          grep -qx 'QDRANT_URL=http://127.0.0.1:6333' /etc/debgpt/vector-service.env
          grep -qx 'QDRANT_COLLECTION=chat_messages' /etc/debgpt/vector-service.env

      - name: Check Qdrant health endpoint
        run: |
          set -euo pipefail
          if [ -f /tmp/debgpt-qdrant-status ] && grep -qx 'missing' /tmp/debgpt-qdrant-status; then
            echo "Qdrant package not installed; skipping health probe." >&2
            exit 0
          fi
          if ! command -v qdrant >/dev/null 2>&1; then
            echo "Qdrant binary not present on system; skipping health probe." >&2
            exit 0
          fi
          curl -fsS --retry 5 --retry-delay 2 --retry-all-errors http://127.0.0.1:6333/healthz | tee /tmp/qdrant-health.json

      - name: Check DebGPT vector service health endpoint
        run: |
          set -euo pipefail
          curl -fsS --retry 5 --retry-delay 2 --retry-all-errors http://127.0.0.1:8000/healthz | tee /tmp/vector-service-health.json

      - name: Verify installed DebGPT packages
        run: |
          set -euo pipefail
          dpkg -l | grep debgpt

      - name: Run lintian
        if: always()
        run: |
          if ls *.changes 1>/dev/null 2>&1; then
            lintian *.changes || true
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debgpt-packages
          path: |
            *.deb
            *.changes
            *.dsc
            *.tar.*
          if-no-files-found: ignore
